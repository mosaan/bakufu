name: "é•·æ–‡AIä¸¦åˆ—è¦ç´„"
description: "é•·æ–‡ã‚’æ®µè½ã«åˆ†å‰²ã—ã€å„æ®µè½ã‚’ä¸¦åˆ—ã§AIè¦ç´„ã—ãŸå¾Œã€å…¨ä½“è¦ç´„ã‚’ç”Ÿæˆ"
version: "1.0"

input_parameters:
  - name: "long_text"
    type: "string"
    required: true
    description: "è¦ç´„ã—ãŸã„é•·æ–‡ãƒ†ã‚­ã‚¹ãƒˆ"
  - name: "target_summary_length"
    type: "integer"
    required: false
    default: 200
    description: "ç›®æ¨™è¦ç´„æ–‡å­—æ•°"

steps:
  # 1. é•·æ–‡ã‚’æ®µè½ã«åˆ†å‰²
  - id: "split_paragraphs"
    type: "text_process"
    method: "regex_extract"
    description: "ãƒ†ã‚­ã‚¹ãƒˆã‚’æ®µè½å˜ä½ã§åˆ†å‰²"
    input: "{{ input.long_text }}"
    pattern: "[^\\n]+(?:\\n(?![\\n])[^\\n]+)*"
    output_format: "array"

  # 2. å„æ®µè½ã‚’ä¸¦åˆ—ã§è¦ç´„ï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œä½¿ç”¨ï¼‰
  - id: "summarize_paragraphs"
    type: "collection"
    operation: "map"
    description: "å„æ®µè½ã‚’ä¸¦åˆ—ã§AIè¦ç´„"
    input: "{{ steps.split_paragraphs }}"
    concurrency:
      max_parallel: 3
      batch_size: 5
      delay_between_batches: 0.5
    error_handling:
      on_item_failure: "skip"
      max_retries_per_item: 2
    steps:
      - id: "paragraph_summary"
        type: "ai_call"
        description: "å€‹åˆ¥æ®µè½ã®è¦ç´„"
        prompt: |
          ä»¥ä¸‹ã®æ®µè½ã‚’ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ï¼š
          
          {{ item }}
          
          è¦ä»¶ï¼š
          - 1-2æ–‡ã§è¦ç´„
          - é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’é€ƒã•ãªã„
          - èª­ã¿ã‚„ã™ã„æ—¥æœ¬èªã§
        # provider: "gemini/gemini-2.0-flash"
        temperature: 0.3
        max_tokens: 200

  # 3. æ®µè½è¦ç´„ã‚’çµ±åˆã—ã¦å…¨ä½“è¦ç´„ã‚’ä½œæˆ
  - id: "create_final_summary"
    type: "ai_call"
    description: "æ®µè½è¦ç´„ã‚’çµ±åˆã—ã¦æœ€çµ‚è¦ç´„ã‚’ä½œæˆ"
    # provider: "gemini/gemini-2.0-flash"
    temperature: 0.5
    max_tokens: 500
    prompt: |
      ä»¥ä¸‹ã®æ®µè½è¦ç´„ã‚’çµ±åˆã—ã¦ã€{{ input.target_summary_length }}æ–‡å­—ç¨‹åº¦ã®å…¨ä½“è¦ç´„ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
      
      æ®µè½è¦ç´„ä¸€è¦§ï¼š
      {% for summary in steps.summarize_paragraphs %}
      {% if summary %}
      - {{ summary }}
      {% endif %}
      {% endfor %}
      
      è¦ä»¶ï¼š
      - è«–ç†çš„ãªæ§‹æˆã§çµ±åˆ
      - é‡è¦åº¦ã«å¿œã˜ã¦å†…å®¹ã‚’å–æ¨é¸æŠ
      - {{ input.target_summary_length }}æ–‡å­—ä»¥å†…
      - èª­ã¿ã‚„ã™ãè‡ªç„¶ãªæ–‡ç« 

output:
  format: "text"
  template: |
    # {{ input.long_text | truncate(50) }}... ã®è¦ç´„
    
    ## ğŸ“ å…¨ä½“è¦ç´„
    {{ steps.create_final_summary }}
    
    ## ğŸ“Š å‡¦ç†çµ±è¨ˆ
    - å…ƒæ–‡å­—æ•°: {{ input.long_text | length }}æ–‡å­—
    - æ®µè½æ•°: {{ steps.split_paragraphs | length }}å€‹
    - è¦ç´„æ®µè½æ•°: {{ steps.summarize_paragraphs | select | list | length }}å€‹
    - è¦ç´„æ–‡å­—æ•°: {{ steps.create_final_summary | length }}æ–‡å­—
    - åœ§ç¸®ç‡: {{ ((steps.create_final_summary | length) / (input.long_text | length) * 100) | round(1) }}%