name: "ãƒ¬ãƒ“ãƒ¥ãƒ¼æ„Ÿæƒ…åˆ†æ"
description: "å•†å“ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã‚’ä¸¦åˆ—ã§æ„Ÿæƒ…åˆ†æã—ã€çµæœã‚’é›†è¨ˆ"
version: "1.0"

input_parameters:
  - name: "reviews"
    type: "array"
    required: true
    description: "åˆ†æå¯¾è±¡ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆ"
  - name: "product_name"
    type: "string" 
    required: false
    default: "å•†å“"
    description: "å•†å“åï¼ˆãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼‰"

steps:
  # 1. å„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¸¦åˆ—ã§æ„Ÿæƒ…åˆ†æï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œä½¿ç”¨ï¼‰
  - id: "analyze_reviews"
    type: "collection"
    operation: "map"
    description: "å„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ„Ÿæƒ…åˆ†æã‚’ä¸¦åˆ—å®Ÿè¡Œ"
    input: "{{ reviews }}"
    concurrency:
      max_parallel: 4
      batch_size: 15
      delay_between_batches: 1.0
    error_handling:
      on_item_failure: "skip"
      max_retries_per_item: 2
    steps:
      - id: "sentiment_analysis"
        type: "ai_call"
        description: "å€‹åˆ¥ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ„Ÿæƒ…åˆ†æ"
        prompt: |
          ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š
          
          {{ item }}
          
          ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
          {
            "sentiment": "positive/negative/neutral",
            "rating": 1-5,
            "confidence": 0.0-1.0,
            "key_points": ["ãƒã‚¤ãƒ³ãƒˆ1", "ãƒã‚¤ãƒ³ãƒˆ2"],
            "summary": "ä¸€è¨€è¦ç´„"
          }
        # provider: "gemini/gemini-2.0-flash"
        temperature: 0.1
        max_tokens: 300

  # 2. åˆ†æçµæœã‚’JSONé…åˆ—ã¨ã—ã¦è§£æ
  - id: "parse_analysis_results"
    type: "text_process"
    method: "json_parse"
    description: "åˆ†æçµæœã‚’JSONå½¢å¼ã§è§£æ"
    input: "[{{ steps.analyze_reviews.output | join(', ') }}]"

  # 3. é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  - id: "generate_summary_report"
    type: "ai_call"
    description: "åˆ†æçµæœã®é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"
    # provider: "gemini/gemini-2.0-flash"
    temperature: 0.3
    max_tokens: 800
    prompt: |
      {{ input.product_name }}ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æçµæœã‚’ã‚‚ã¨ã«ã€åŒ…æ‹¬çš„ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
      
      åˆ†æãƒ‡ãƒ¼ã‚¿ï¼š
      {{ steps.parse_analysis_results.output | tojson }}
      
      ä»¥ä¸‹ã®è¦³ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ï¼š
      1. å…¨ä½“çš„ãªæ„Ÿæƒ…åˆ†å¸ƒï¼ˆpositive/negative/neutralï¼‰
      2. å¹³å‡è©•ä¾¡ã¨è©•ä¾¡åˆ†å¸ƒ
      3. ä¸»è¦ãªè©•ä¾¡ãƒã‚¤ãƒ³ãƒˆï¼ˆè‰¯ã„ç‚¹ãƒ»æ‚ªã„ç‚¹ï¼‰
      4. æ”¹å–„ææ¡ˆ
      5. ç·åˆçš„ãªè©•ä¾¡ã‚µãƒãƒªãƒ¼
      
      èª­ã¿ã‚„ã™ãMarkdownå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

output:
  format: "text"
  template: |
    # {{ input.product_name }} ãƒ¬ãƒ“ãƒ¥ãƒ¼æ„Ÿæƒ…åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
    
    ## ğŸ“Š åŸºæœ¬çµ±è¨ˆ
    - åˆ†æãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°: {{ input.reviews | length }}ä»¶
    - å‡¦ç†æˆåŠŸæ•°: {{ steps.analyze_reviews.output | select | list | length }}ä»¶
    - å‡¦ç†æˆåŠŸç‡: {{ ((steps.analyze_reviews.output | select | list | length) / (input.reviews | length) * 100) | round(1) }}%
    
    ---
    
    {{ steps.generate_summary_report.output }}
    
    ---
    
    ## ğŸ” è©³ç´°åˆ†æãƒ‡ãƒ¼ã‚¿
    
    {% for result in steps.parse_analysis_results.output %}
    {% if result %}
    ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ {{ loop.index }}
    - **æ„Ÿæƒ…**: {{ result.sentiment }}
    - **è©•ä¾¡**: {{ result.rating }}/5
    - **ä¿¡é ¼åº¦**: {{ (result.confidence * 100) | round(1) }}%
    - **è¦ç´„**: {{ result.summary }}
    - **ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ**: {{ result.key_points | join(', ') }}
    
    {% endif %}
    {% endfor %}