name: "ãƒ­ã‚°è§£æ"
description: "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è§£æã—ã€ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"

input_parameters:
  - name: "log_data"
    type: "string"
    required: true
    description: "è§£æã™ã‚‹ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿"
  - name: "time_range"
    type: "string"
    required: false
    description: "è§£æå¯¾è±¡ã®æ™‚é–“ç¯„å›²"
    default: "å…¨æœŸé–“"

steps:
  - id: "extract_log_entries"
    type: "text_process"
    description: "ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’æŠ½å‡º"
    method: "regex_extract"
    input: "{{ input.log_data }}"
    pattern: '(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}.*?)(?=\n\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}|$)'
    flags: ["MULTILINE", "DOTALL"]
    output_format: "array"

  - id: "extract_error_logs"
    type: "text_process"
    description: "ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’æŠ½å‡º"
    method: "regex_extract"
    input: "{{ input.log_data }}"
    pattern: '.*(ERROR|FATAL|Exception|Error).*'
    flags: ["IGNORECASE", "MULTILINE"]
    output_format: "array"

  - id: "extract_timestamps"
    type: "text_process"
    description: "ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ½å‡º"
    method: "regex_extract"
    input: "{{ input.log_data }}"
    pattern: '(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})'
    flags: ["MULTILINE"]
    output_format: "array"

  - id: "analyze_log_patterns"
    type: "ai_call"
    description: "ãƒ­ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æ"
    prompt: |
      ä»¥ä¸‹ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š

      è§£ææœŸé–“: {{ input.time_range }}
      
      å…¨ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªæ•°: {{ steps.extract_log_entries | length }}
      ã‚¨ãƒ©ãƒ¼æ•°: {{ steps.extract_error_logs | length }}
      
      ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚µãƒ³ãƒ—ãƒ«:
      {% for error in steps.extract_error_logs[:10] %}
      {{ loop.index }}. {{ error }}
      {% endfor %}

      ä»¥ä¸‹ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š
      1. ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã¨é »åº¦
      2. ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ™‚é–“å¸¯ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
      3. æœ€ã‚‚é‡è¦ãªã‚¨ãƒ©ãƒ¼ï¼ˆå¯¾å¿œå„ªå…ˆåº¦ï¼‰
      4. ã‚·ã‚¹ãƒ†ãƒ ã®å¥å…¨æ€§è©•ä¾¡

  - id: "extract_performance_metrics"
    type: "text_process"
    description: "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æŠ½å‡º"
    method: "regex_extract"
    input: "{{ input.log_data }}"
    pattern: '.*(response_time|latency|duration|ms|seconds).*?(\d+\.?\d*)'
    flags: ["IGNORECASE", "MULTILINE"]
    output_format: "array"

  - id: "performance_analysis"
    type: "ai_call"
    description: "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ"
    prompt: |
      ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š

      æŠ½å‡ºã•ã‚ŒãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹:
      {{ steps.extract_performance_metrics }}

      å…¨ä½“ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿:
      {{ steps.extract_log_entries | length }}ä»¶ã®ã‚¨ãƒ³ãƒˆãƒª

      ä»¥ä¸‹ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š
      1. å¿œç­”æ™‚é–“ã®å‚¾å‘
      2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯
      3. ç•°å¸¸ã«é…ã„å‡¦ç†ã®ç‰¹å®š
      4. æ”¹å–„ææ¡ˆ

  - id: "generate_recommendations"
    type: "ai_call"
    description: "æ”¹å–„ææ¡ˆã‚’ç”Ÿæˆ"
    prompt: |
      ãƒ­ã‚°åˆ†æçµæœã«åŸºã¥ã„ã¦æ”¹å–„ææ¡ˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

      ãƒ­ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ:
      {{ steps.analyze_log_patterns }}

      ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ:
      {{ steps.performance_analysis }}

      ä»¥ä¸‹ã‚’å«ã‚€æ”¹å–„ææ¡ˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
      1. ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ãªå•é¡Œ
      2. ä¸­é•·æœŸçš„ãªæ”¹å–„é …ç›®
      3. ç›£è¦–å¼·åŒ–ã™ã¹ãé ˜åŸŸ
      4. å…·ä½“çš„ãªå¯¾å¿œæ‰‹é †

  - id: "create_report"
    type: "text_process"
    description: "è§£æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ"
    method: "replace"
    input: |
      # ğŸ” ãƒ­ã‚°è§£æãƒ¬ãƒãƒ¼ãƒˆ

      ## ğŸ“Š è§£ææ¦‚è¦
      - **è§£ææœŸé–“**: {{ input.time_range }}
      - **ç·ãƒ­ã‚°æ•°**: {{ steps.extract_log_entries | length }}ä»¶
      - **ã‚¨ãƒ©ãƒ¼æ•°**: {{ steps.extract_error_logs | length }}ä»¶
      - **ã‚¨ãƒ©ãƒ¼ç‡**: {{ ((steps.extract_error_logs | length) / (steps.extract_log_entries | length) * 100) | round(2) }}%

      ## âš ï¸ ã‚¨ãƒ©ãƒ¼åˆ†æ
      {{ steps.analyze_log_patterns }}

      ## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
      {{ steps.performance_analysis }}

      ## ğŸ’¡ æ”¹å–„ææ¡ˆ
      {{ steps.generate_recommendations }}

      ## ğŸ“‹ æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ (ä¸Šä½10ä»¶)
      {% for error in steps.extract_error_logs[:10] %}
      {{ loop.index }}. {{ error[:100] }}...
      {% endfor %}

      ---
      ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ™‚åˆ»: {{ now().strftime("%Y-%m-%d %H:%M:%S") }}
    replacements:
      - pattern: '{{ \(\(steps\.extract_error_logs \| length\) / \(steps\.extract_log_entries \| length\) \* 100\) \| round\(2\) }}'
        to: "è¨ˆç®—çµæœ"

output:
  format: "text"
  template: "{{ steps.create_report }}"